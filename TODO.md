# TODO

現在の実装を安定的に保ちながら、段階的な RSMD ロードマップを追跡しています。

## 近期のPR

1. PR0 – ビルド修正 + スモークテスト
   - `packages/core/src/slugify.rs` 内の `use crate::HashSet;` を `use std::collections::HashSet;` に置換する。
   - `cargo build && cargo test` が正常に動作するよう、少なくとも 1 つの基本的な単体テストを追加する。

2. PR1 – pulldown-cmark 配線（MVP）
   - `pulldown-cmark` を使用して実際の `<p>` / `<h1>` HTML を出力する。
   - `render("# A")` が `<h1>…</h1>` と有効な `RenderResult` を返すことを確認する。
   - この段階では「正しくレンダリングできること」を優先し、見出し収集は暫定実装（2 パス）でもよい。

3. PR2 – 見出し収集（イベントベース・スラグなし）
   - 行ベース／正規表現ではなく、`pulldown_cmark::Event` の `Tag::Heading` を用いて見出しを収集する。
   - CommonMark 準拠の見出し検出に修正する：
     - コードブロック内の `# Heading` を見出しとして扱わない。
     - ATX 見出しで `#word` のようなケースは無効とし、`# Heading`（`#` の後に空白 or 行末）だけを有効とする。
     - `#######` のように 7 個以上 `#` が続く行は見出しとして扱わない（レベル 1〜6 のみ有効）。
     - setext スタイル（`Heading` + `===` / `---`）は将来的な対応候補として扱い、スコープを文書化しておく。
   - まずはレベル 1 見出しの `{ depth, text }` のみを `headings` に収集する（スラグ付与は PR3 以降）。

4. PR3 – ASCII スラグ化（衝突処理付き）
   - 衝突処理付き ASCII のみのスラグ生成を実装する（例: `a`, `a-2`, `a-3`, …）。
   - レベル 1 見出しに ASCII スラグを添付する。
   - 代表的なケースについてテストを追加する：
     - 同じ見出しテキストが複数回出現する場合の衝突回避。
     - 英数字＋空白／句読点の正規化ルール。

5. PR4 – Unicode / CJK スラグ化とドキュメント整備
   - CJK 対応ルール（空白除去、句読点削除など）でスラグ化を拡張する。
   - `CJK CJK` / `CJK ASCII CJK` / `ASCII CJK ASCII` などのパターンで、
     - どこにハイフンを入れるか
     - どのケースでハイフンを削除するか
     を明示したテストを追加し、現在の `last_hyphen` ロジックを検証・必要に応じて修正する。
   - `is_cjk.rs` のドキュメントを **「Unicode 16」→「Unicode 16.0」** のように正しい表記へ更新する。
   - 日本語／混合見出しのテストを追加し、CJK 含むスラグの一貫性を確認する。

6. PR5 – 見出し範囲拡張 + シングルパス化
   - 見出し収集の範囲を h1〜h3 に拡張し、それぞれにスラグを割り当てる。
   - 生成された HTML に `id="slug"` を挿入する（例: `<h2 id="...">`）。
   - 現状の「HTML 生成 + 生テキスト再パース」による 2 パス構成を見直し、
     - `pulldown-cmark` のイベントストリーム１回の走査で
       - HTML 生成
       - 見出し収集
       を同時に行うように最適化する（ドキュメントで約束している single-pass 方針との整合性を取る）。

7. PR6 – wasm-bindgen 最小限エクスポート
   - `wasm32-unknown-unknown` をターゲットとする際に既存のクレートに対して `render_wasm` を公開する。
   - `wasm-pack build --target bundler` を成功させる。
   - 基本的なエラー伝搬と戻り値シリアライズ（`RenderResult` 相当）を確認する。

8. PR7 – Node スモークテスト
   - WASM バンドルを読み込み `render("# A")` をアサートする Vitest を含む `examples/node/` を追加する。
   - `pnpm test:node` を CI に組み込み、Node 経由の最小パスが常に動作することを保証する。

9. PR8 – ブラウザスモークテスト
   - `examples/web/`（例: Vite）を追加し、ブラウザ上で WASM レンダーパスを実行する Playwright テストを追加する。
   - 少なくとも 1 つの簡単な Markdown 入力に対して、HTML 出力と見出し情報の双方を検証する。

10. PR9 – README 現実チェック
    - README を RSMD MVP に焦点を当てるよう更新し、ハイブリッド計画を「将来の作業」に移動する。
    - 現状の実装が
      - どこまで single-pass か
      - どこが暫定的な 2 パス実装なのか
      を明示し、性能目標と今後の最適化 PR（PR5 など）との対応関係を書いておく。
    - Unicode バージョン表記（16.0）や CJK 対応スコープを README / DESIGN 両方で揃える。
    - クイックスタートガイド（Rust / WASM / Node / Web それぞれの最小例）を追加する。

11. PR10 – 最小限 CLI（オプション）
    - 見出し出力用の `--json` 付き `stdin` → `stdout` CLI を提供し、README に文書化する。
    - CI で簡単な CLI スモークテスト（`echo "# A" | rsmd-cli --json`）を回す。

## バックログ

- h4〜h6 見出しと TOC ユーティリティのサポート。
- HTML 対応範囲（リスト、コードブロック、リンクなど）を小さな増分で拡張。
- リグレッション用のスナップショット / プロパティテストを追加。
- エラータイプと public ABI を安定化。
- WASM vs. ネイティブバイナリのパッケージング戦略を評価。
- setext 見出しや GFM 拡張など、CommonMark 準拠レベルをどこまで目指すかのポリシーを DESIGN に明文化。
